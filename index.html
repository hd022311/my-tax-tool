<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯Œé‚¦ä¿Šå¾· | å‚³æ‰¿ä¿å…¨æ™ºæ…§è©¦ç®—</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .input-card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; padding: 1.25rem; margin-bottom: 1rem; }
        .fubon-blue { color: #004a99; }
    </style>
</head>
<body class="pb-20">
    <div class="max-w-md mx-auto p-4">
        
        <div class="flex items-center gap-4 bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 mb-6 mt-4">
            <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-blue-100 shrink-0 bg-slate-50">
                <img id="profilePic" src="https://drive.google.com/thumbnail?id=1DIjJdTt_HDEYrAJVj0yKzbO81pQG2Ndh&sz=w200" class="w-full h-full object-cover">
            </div>
            <div>
                <h2 class="text-xs font-bold text-slate-400">æ‚¨å¥½ <span id="userName" class="text-blue-600 font-black">å˜‰è³“</span>ï¼Œæˆ‘æ˜¯</h2>
                <h2 class="text-lg font-black fubon-blue leading-tight">å¯Œé‚¦äººå£½ | ä¿Šå¾·</h2>
            </div>
        </div>

        <div class="text-center mb-6">
            <h1 class="text-xl font-black text-slate-800 tracking-tight">è³‡ç”¢ä¿å…¨èˆ‡ç‰¹ç•™åˆ†è©¦ç®—</h1>
            <p class="text-[10px] font-bold text-slate-400 mt-1 italic">ğŸ’¡ è‡ªå‹•åˆ¤å®šé †ä½ï¼Œåˆ†æç¥–ç”¢é¢¨éšª</p>
        </div>

        <div class="input-card border-t-4 border-t-[#004a99] shadow-sm">
            <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">ğŸ’° è³‡ç”¢ç¾æ³ (è¬å…ƒ)</h3>
            <div class="space-y-3">
                <div class="relative">
                    <label class="text-[10px] font-bold text-blue-700 absolute left-3 top-1 italic">æˆ¿ç”¢å¸‚åƒ¹</label>
                    <input type="number" id="realEstate" placeholder="è«‹è¼¸å…¥é‡‘é¡" class="w-full pt-5 pb-2 px-3 bg-slate-50 rounded-xl border-0 text-right font-black text-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-400 absolute left-3 top-1">å­˜æ¬¾ç¾é‡‘</label>
                        <input type="number" id="cash" placeholder="0" class="w-full pt-5 pb-2 px-3 bg-slate-50 rounded-xl border-0 text-right font-bold">
                    </div>
                    <div class="relative">
                        <label class="text-[10px] font-bold text-slate-400 absolute left-3 top-1">è‚¡ç¥¨åŸºé‡‘</label>
                        <input type="number" id="stock" placeholder="0" class="w-full pt-5 pb-2 px-3 bg-slate-50 rounded-xl border-0 text-right font-bold">
                    </div>
                </div>
            </div>
        </div>

        <div class="input-card shadow-sm">
            <h3 class="font-bold text-slate-700 mb-3 text-sm">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­æˆå“¡çµæ§‹</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-xl border border-blue-100">
                    <span class="font-bold text-blue-800 text-sm">é…å¶æ˜¯å¦åœ¨ä¸–</span>
                    <input type="checkbox" id="hasSpouse" class="w-5 h-5 rounded text-blue-600">
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-sm">
                        <span class="font-bold text-slate-600">å­å¥³å¹¾ä½ï¼Ÿ</span>
                        <input type="number" id="numChildren" value="0" min="0" class="w-16 bg-slate-100 p-2 text-center rounded-lg border-0 font-black">
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="font-bold text-slate-400">çˆ¶æ¯å¹¾ä½ï¼Ÿ</span>
                        <input type="number" id="numParents" value="0" min="0" class="w-16 bg-slate-100 p-2 text-center rounded-lg border-0 font-black">
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="font-bold text-slate-400">å…„å¼Ÿå§Šå¦¹ï¼Ÿ</span>
                        <input type="number" id="numSiblings" value="0" min="0" class="w-16 bg-slate-100 p-2 text-center rounded-lg border-0 font-black">
                    </div>
                </div>
            </div>
        </div>

        <button onclick="calculate()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition-all text-lg mb-8">
            ç”Ÿæˆå°ˆæ¥­å‚³æ‰¿åˆ†æå ±å‘Š
        </button>

        <div id="resultArea" class="hidden mb-12">
            <div class="bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200">
                <div class="bg-[#004a99] p-5 text-center text-white">
                    <h3 class="font-black text-lg">è³‡ç”¢ä¿å…¨å»ºè­°å ±å‘Š</h3>
                </div>
                <div id="resultContent" class="p-6 space-y-5"></div>
                <div class="p-6 pt-0">
                    <a href="https://line.me/ti/p/ä½ çš„ID" class="block w-full bg-green-500 text-white text-center py-4 rounded-xl font-black shadow-md flex items-center justify-center gap-2">
                        ğŸ’¬ è¯ç¹«ä¿Šå¾·é ç´„ 1 å° 1 è«®è©¢
                    </a>
                </div>
                <div class="p-4 bg-slate-50 border-t text-[9px] text-slate-400 text-center leading-relaxed px-6">
                    âš ï¸ è¨»ï¼šæœ¬è©¦ç®—ä¾æ°‘æ³•èˆ‡ 113å¹´æ†²åˆ¤å­—ç¬¬3è™Ÿç²¾ç¥ç·¨è£½ã€‚å¯¦éš›åˆ†é…è«‹æ´½å°ˆæ¥­é¡§å•ä¿Šå¾·é€²è¡Œå€‹æ¡ˆè©•ä¼°ã€‚
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserName = "åŒ¿åå˜‰è³“";

        // 1. åˆå§‹åŒ– LIFF (æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶æª¢æŸ¥ç™»å…¥ç‹€æ…‹)
        async function initLIFF() {
            try {
                await liff.init({ liffId: "2008902145-dYIF2R2M" });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    currentUserName = profile.displayName;
                    document.getElementById('userName').innerText = currentUserName;
                    if (profile.pictureUrl) {
                        document.getElementById('profilePic').src = profile.pictureUrl;
                    }
                } else {
                    // é—œéµï¼šæœªç™»å…¥æ™‚å¼·åˆ¶é–‹å•Ÿç™»å…¥è¦–çª—
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF åˆå§‹åŒ–å‡ºéŒ¯", err);
            }
        }
        initLIFF();

        // 2. è‡ªå‹•å‚³é€æ•¸æ“šåˆ° Google è¡¨å–®
        function logToGoogleForm(data) {
            const actualFormID = "1lpAzMM1FJQaC8Nqfj6776KQZ-cihe0qVsXo1m4U--XU";
            const url = `https://docs.google.com/forms/d/e/${actualFormID}/formResponse?` +
                        `entry.31174987=${encodeURIComponent(currentUserName)}&` +
                        `entry.1130638521=${data.total}&` +
                        `entry.650225126=${encodeURIComponent(data.ratio + '%')}&` +
                        `entry.2001556012=${encodeURIComponent(data.structure)}&` +
                        `entry.1017830689=${encodeURIComponent(data.plan)}&` +
                        `submit=Submit`;
            fetch(url, { mode: 'no-cors' });
        }

        // 3. è¨ˆç®—é‚è¼¯
        function calculate() {
            const re = parseFloat(document.getElementById('realEstate').value) || 0;
            const cash = parseFloat(document.getElementById('cash').value) || 0;
            const stock = parseFloat(document.getElementById('stock').value) || 0;
            const totalBefore = re + cash + stock;

            const hasSpouse = document.getElementById('hasSpouse').checked;
            const nChild = parseInt(document.getElementById('numChildren').value) || 0;
            const nParent = parseInt(document.getElementById('numParents').value) || 0;
            const nSibling = parseInt(document.getElementById('numSiblings').value) || 0;

            if (totalBefore <= 0) { alert('è«‹è¼¸å…¥è³‡ç”¢é‡‘é¡'); return; }

            // è‡ªå‹•åˆ¤å®šæ³•å¾‹é †ä½
            let rank = 0; let count = 0; let rankTitle = "";
            if (nChild > 0) { rank = 1; count = nChild; rankTitle = "ç¬¬ä¸€é †ä½(å­å¥³)"; }
            else if (nParent > 0) { rank = 2; count = nParent; rankTitle = "ç¬¬äºŒé †ä½(çˆ¶æ¯)"; }
            else if (nSibling > 0) { rank = 3; count = nSibling; rankTitle = "ç¬¬ä¸‰é †ä½(å…„å¼Ÿå§Šå¦¹)"; }
            else { alert('è«‹å¡«å¯«ç¹¼æ‰¿æˆå“¡çµæ§‹'); return; }

            // ç­–ç•¥åˆ¤å®š
            const ratio = (re / totalBefore); 
            const isREPlan = (ratio > 0.7); 
            let insShift = isREPlan ? (re * 0.3) : (cash + stock);
            const totalAfter = totalBefore - insShift;

            // åŒæ­¥æ•¸æ“š
            logToGoogleForm({
                total: totalBefore,
                ratio: Math.round(ratio * 100),
                structure: `é…å¶:${hasSpouse?'æœ‰':'ç„¡'},å­:${nChild},çˆ¶:${nParent},å…„:${nSibling}`,
                plan: isREPlan ? 'æˆ¿ç”¢æ´»åŒ–ä¿å…¨' : 'é‡‘èå‚³æ‰¿å„ªåŒ–'
            });

            // ç‰¹ç•™åˆ†ç‡è¨ˆç®—
            let sShare = 0, hShare = 0, hRate = (rank <= 2) ? 0.5 : 0.3333;
            if (hasSpouse) {
                if (rank === 1) { sShare = 1/(count+1); hShare = 1/(count+1); }
                else if (rank === 2 || rank === 3) { sShare = 0.5; hShare = 0.5/count; }
            } else { hShare = 1/count; }

            document.getElementById('resultArea').classList.remove('hidden');

            // ä¿®æ³•è­¦ç¤ºå€
            let legalAlert = (rank === 3) ? `
                <div class="p-3 bg-amber-50 rounded-xl border border-amber-200 mt-2 shadow-inner">
                    <p class="text-amber-800 font-black text-[10px]">âš–ï¸ 113æ†²åˆ¤å­—ç¬¬3è™Ÿæé†’</p>
                    <p class="text-[9px] text-amber-700 leading-relaxed font-bold">
                        ç›®å‰å…„å¼Ÿå§Šå¦¹ç‰¹ç•™åˆ†å·²è¢«å®£å‘Šé•æ†²ã€‚åœ¨æ³•å¾‹ä¿®è¨‚éæ¸¡æœŸï¼Œé€éä¿éšªæŒ‡å®šå—ç›Šäººæ˜¯æ’é™¤çˆ­è­°æœ€ç©©å¦¥çš„æ‰‹æ®µã€‚
                    </p>
                </div>
            ` : "";

            document.getElementById('resultContent').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-3 rounded-xl text-center border">
                        <p class="text-[9px] text-slate-400 font-black">åŸå§‹éºç”¢ç¸½é¡</p>
                        <p class="text-lg font-black text-slate-700">${Math.round(totalBefore).toLocaleString()}è¬</p>
                    </div>
                    <div class="bg-[#004a99] p-3 rounded-xl text-center shadow-lg">
                        <p class="text-[9px] text-blue-200 font-black">å„ªåŒ–å¾Œè¨ˆç®—åŸºæº–</p>
                        <p class="text-lg font-black text-white">${Math.round(totalAfter).toLocaleString()}è¬</p>
                    </div>
                </div>

                <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                    <p class="text-xs font-black text-[#004a99] mb-1">ğŸ¯ ä¿Šå¾·è¦åŠƒï¼š${isREPlan?'æˆ¿ç”¢æ´»åŒ–ä¿å…¨':'é‡‘èå‚³æ‰¿å„ªåŒ–'}</p>
                    <p class="text-[10px] text-blue-700 font-bold leading-relaxed">
                        å»ºè­°å°‡ <span class="text-[#004a99] underline">${Math.round(insShift).toLocaleString()} è¬</span> è¦åŠƒç‚ºäººå£½ä¿éšªé‡‘ã€‚ç†è³ é‡‘ä¾æ³•ä¸è¨ˆå…¥éºç”¢ï¼Œå¯æœ‰æ•ˆå¤§å¹…ç¸®æ¸›ç‰¹ç•™åˆ†è² æ“”ã€‚
                    </p>
                </div>

                ${legalAlert}

                <div class="p-4 bg-red-50 rounded-2xl border-l-4 border-red-500 shadow-sm">
                    <h5 class="text-red-700 font-black text-[11px] mb-1 italic">âš ï¸ æ ¸å¿ƒå±æ©Ÿï¼šç¥–ç”¢é–æ­»é¢¨éšª</h5>
                    <p class="text-[10px] text-red-600 font-bold leading-relaxed">
                        æ‚¨çš„ä¸»è¦ç¹¼æ‰¿äººç‚º <b>${rankTitle}</b>ã€‚è‹¥ç¾é‡‘å„²å‚™ä¸è¶³ä»¥æ”¯æ‡‰ç‰¹ç•™åˆ†ï¼Œæˆ¿ç”¢æè¢«å¼·åˆ¶è½‰ç‚ºã€Œå…¬åŒå…±æœ‰ã€ï¼Œå°è‡´ç”¢æ¬Šç³¾ç´›ç„¡æ³•è™•åˆ†ã€‚
                    </p>
                </div>

                <div class="space-y-3">
                    <h4 class="text-[9px] font-black text-slate-400 tracking-widest uppercase ml-1">è¦åŠƒå¾Œå–®äººç‰¹ç•™åˆ†ä¼°ç®—</h4>
                    ${renderRow("é…å¶", sShare, 0.5, totalBefore, totalAfter, hasSpouse)}
                    ${renderRow(rankTitle, hShare, hRate, totalBefore, totalAfter, true)}
                </div>
            `;
            document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
        }

        function renderRow(label, share, rate, b, a, show) {
            if (!show) return '';
            const aV = a * share * rate;
            return `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <span class="text-[10px] font-bold text-slate-600">${label}</span>
                    <div class="text-right">
                        <span class="text-md font-black text-[#004a99]">${aV.toFixed(1)}è¬</span>
                        <span class="text-[9px] font-black text-white bg-emerald-500 px-2 rounded-full ml-1">è¦åŠƒç”Ÿæ•ˆ</span>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
